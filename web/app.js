const t={en:{models_title:"Models",download:"Download",download_quant8:"Download+INT8",chat_title:"Chat",quant_int8:"Quant INT8",quant_int4:"Quant INT4",generate:"Send",del:"Delete",release:"Release",refresh:"Refresh",thinking:"Thinking...",continue:"Continue",no_models_hint:"No models available. Download in Model Management",goto_models:"Go to Models",about_title:"About",about_intro:"AI Funland is a local AI inference and model management UI built on OpenVINO GenAI. It supports model download, INT8/INT4 weight-only quantization, device selection (CPU/GPU/NPU/NVIDIA), performance tuning, and a natural chat interface with think/final separation."},zh:{models_title:"模型",download:"下载",download_quant8:"下载+INT8量化",chat_title:"对话",quant_int8:"INT8量化",quant_int4:"INT4量化",generate:"发送",del:"删除",release:"释放",refresh:"刷新",thinking:"正在思考...",continue:"继续生成",no_models_hint:"当前没有可用模型，请在“模型管理”页面下载",goto_models:"前往模型管理",about_title:"关于",about_intro:"AI Funland 是基于 OpenVINO GenAI 的本地 AI 推理与模型管理界面，支持模型下载、INT8/INT4 权重量化、设备选择（CPU/GPU/NPU/NVIDIA）、性能调优，以及支持思考/最终答案拆分的自然聊天体验。"}}
let lang="en"
const $=s=>document.querySelector(s)
function setLang(l){lang=l;document.querySelectorAll("[data-i18n]").forEach(e=>{const k=e.getAttribute("data-i18n");e.textContent=t[l][k]||k})}
function showPage(name){const pid="page_"+name;document.querySelectorAll('.page').forEach(p=>{p.classList.toggle('active',p.id===pid)});document.querySelectorAll('.nav .navlink').forEach(a=>{a.classList.toggle('active',a.getAttribute('data-page')===name)})}
async function sys(){const r=await fetch("/api/system/info");const j=await r.json();const acc=$("#accelerator");acc.innerHTML="";j.accelerators.forEach(a=>{const o=document.createElement("option");o.value=a.id;o.textContent=a.label;acc.appendChild(o)});const baseInfo=`${j.os} ${j.os_version} · Python ${j.python} · Devices ${j.openvino_devices.join(", ")}`;const about=$("#sysinfo_about");if(about)about.textContent=baseInfo;const hm=j.hardware_models||{};const mem=j.memory||{};let memStr="";if(mem&&mem.total_bytes){const totalGB=(mem.total_bytes/1024/1024/1024).toFixed(1);const usedGB=(mem.used_bytes/1024/1024/1024).toFixed(1);const perc=(typeof mem.used_percent==="number")?Math.round(mem.used_percent):null;memStr=`内存: ${usedGB}/${totalGB} GB${perc!==null?` (${perc}%)`:""}`};const cpuStr=hm.cpu?`CPU: ${hm.cpu}`:"";const gpuList=Array.isArray(hm.gpu)?hm.gpu:[];const gpuStr=gpuList.length?`GPU: ${gpuList.join(", ")}`:"";const npuStr=hm.npu?`NPU: ${hm.npu}`:"";const nvList=Array.isArray(j.nvidia_gpus)?j.nvidia_gpus:[];const nvStr=nvList.length?`NVIDIA: ${nvList.map(x=>x.name).join(", ")}`:"";const hw=$("#sys_hw");if(hw){const v=(acc.value||"CPU");const line=[baseInfo,cpuStr,npuStr,gpuStr,nvStr,memStr,`当前加速器: ${v}`].filter(Boolean).join(" · ");hw.textContent=line};const archEl=$("#device_arch");if(archEl){const arch=j.device_architecture||{};archEl.innerHTML=Object.keys(arch).length?Object.entries(arch).map(([k,v])=>`${k}: ${v}`).join(" · "):""}const hintsEl=$("#ov_hints_view");if(hintsEl){const h=j.ov_hints||{};hintsEl.textContent=Object.entries(h).map(([k,v])=>`${k}=${v||"-"}`).join(" · ")};const hv=$("#hardware_view");if(hv){const line=[cpuStr,npuStr,gpuStr,nvStr,memStr].filter(Boolean).join(" · ");hv.textContent=line}}
function updateAccelInfo(){const acc=$("#accelerator");const v=acc.value||"CPU";const hw=$("#sys_hw");if(hw){const base=hw.textContent.replace(/\s*·\s*当前加速器:[\s\S]*$/,'');hw.textContent=`${base} · 当前加速器: ${v} · 推荐使用Intel NPU/GPU以获得最佳性能`}}
async function listModels(){const r=await fetch("/api/models/list");const j=await r.json();const c=$("#model_list");c.innerHTML="";const sel=$("#model_select");sel.innerHTML="";j.items.forEach(m=>{const d=document.createElement("div");d.className="item";const a=document.createElement("div");a.textContent=`${m.id} · ${(m.size_bytes/1024/1024).toFixed(2)} MB`;const b=document.createElement("div");const del=document.createElement("button");del.textContent=t[lang].del;del.onclick=async()=>{await fetch("/api/models/delete",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:m.id})});await listModels()};b.appendChild(del);d.appendChild(a);d.appendChild(b);c.appendChild(d);const opt=document.createElement("option");opt.value=m.id;opt.textContent=m.id;sel.appendChild(opt)});const hint=$("#no_models_hint");if(hint)hint.style.display=sel.options.length?"none":"block"}
async function startDownload(){const id=$("#model_id").value.trim();if(!id)return;const include=$("#include").value.trim();const exclude=$("#exclude").value.trim();const revision=$("#revision").value.trim();const body={model_id:id};if(include)body.include=include.split(/\s+/);if(exclude)body.exclude=exclude.split(/\s+/);if(revision)body.revision=revision;const r=await fetch("/api/models/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});const j=await r.json();pollTask(j.task_id,async()=>{await listModels();const expected=id.replace(/\//g,"__");const sel=$("#model_select");const found=Array.from(sel.options).some(o=>o.value===expected);if(!found){showRefreshTip(lang==="zh"?"模型列表未更新，请刷新页面":"Models list not updated, please refresh")}})}
async function pollTask(taskId,onDone){const s=$("#download_status");s.innerHTML="";const wrap=document.createElement("div");wrap.className="progress";const bar=document.createElement("div");bar.className="bar";wrap.appendChild(bar);s.appendChild(wrap);const msg=document.createElement("div");s.appendChild(msg);let done=false;while(!done){const r=await fetch(`/api/tasks/${taskId}`);if(r.status!==200){msg.textContent="error";break}const j=await r.json();const p=Number(j.progress||0);if(j.status==="running"&&(p<=1)){wrap.classList.add("ind")}else{wrap.classList.remove("ind");bar.style.width=p+"%"}let friendlyMsg=j.message||"";if(friendlyMsg==="api_download"){friendlyMsg=(lang==="zh"?"正在通过 ModelScope API 下载...":"Downloading via ModelScope API...")};if(j.status==="running"&&p>1){msg.textContent=`${friendlyMsg} · ${p}%`}else{msg.textContent=friendlyMsg}if(j.status==="completed"){done=true;if(onDone)onDone()}if(j.status==="error"){done=true;const err=j.error||"error";if(/Calibration dataset is required/i.test(err)){showRefreshTip(lang==="zh"?"当前量化策略需要校准数据，建议选择 INT8 权重量化，或刷新页面查看列表":"Data-aware quantization requires calibration dataset. Please use INT8 or refresh.");msg.textContent=err}else{msg.textContent=err}}await new Promise(res=>setTimeout(res,1000))}}
async function downloadAndQuantizeInt8(){const id=$("#model_id").value.trim();if(!id)return;const include=$("#include").value.trim();const exclude=$("#exclude").value.trim();const revision=$("#revision").value.trim();const body={model_id:id};if(include)body.include=include.split(/\s+/);if(exclude)body.exclude=exclude.split(/\s+/);if(revision)body.revision=revision;const r=await fetch("/api/models/download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});const j=await r.json();if(!j.task_id)return;await new Promise(res=>pollTask(j.task_id,res));const modelLocalId=id.replace(/\//g,"__");const rq=await fetch("/api/models/quantize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:modelLocalId,mode:"int8"})});const jq=await rq.json();if(jq.task_id){await new Promise(res=>pollTask(jq.task_id,res));await listModels();const sel=$("#model_select");const target=modelLocalId+"_quant_int8";const found=Array.from(sel.options).some(o=>o.value===target);if(!found){showRefreshTip(lang==="zh"?"模型列表未更新，请刷新页面":"Models list not updated, please refresh")}else{sel.value=target}}}
async function quantize(mode){const sel=$("#model_select");const id=sel.value;if(!id)return;const r=await fetch("/api/models/quantize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,mode})});const j=await r.json();if(j.task_id)pollTask(j.task_id,async()=>{await listModels();const target=id+"_quant_"+mode;const found=Array.from($("#model_select").options).some(o=>o.value===target);if(!found){showRefreshTip(lang==="zh"?"模型列表未更新，请刷新页面":"Models list not updated, please refresh")}})}
function showAlert(msg,docs,rec){const a=$("#alert");const m=$("#alert_msg");m.innerHTML=`${msg} <br> ${docs?`<a href='${docs}' target='_blank'>兼容性文档</a>`:""} ${rec&&rec.length?`· ${(rec||[]).join(', ')}`:""}`;a.style.display="flex"}
function showRefreshTip(text){const a=$("#alert");const m=$("#alert_msg");m.innerHTML=`${text} <button id='btn_refresh' style='margin-left:8px'>${t[lang].refresh}</button>`;a.style.display="flex";setTimeout(()=>{const br=document.querySelector('#btn_refresh');if(br)br.onclick=()=>location.reload()},0)}
let _firstLoadShown={}
function hideAlert(){const a=$("#alert");a.style.display="none"}
function showOverlay(){const ov=$("#loading_overlay");ov.classList.remove("hidden");setTimeout(()=>{$("#loading_tip").style.display="block"},5000)}
function hideOverlay(){const ov=$("#loading_overlay");ov.classList.add("hidden");$("#loading_tip").style.display="none"}
const chat=[]
function parseThink(text){try{const hasOpen=/<think[\s\S]*?>/i.test(text);const closeIdx=text.search(/<\/think>/i);if(!hasOpen&&closeIdx>=0){const think=text.slice(0,closeIdx+8);let final=text.slice(closeIdx+8);final=final.replace(/<final>|<\/final>/gi,"").trim();return{think,final}}const m=text.match(/<think[\s\S]*?>([\s\S]*?)(?:<\/think>|$)/i);const think=m?((m[1]||"").trim()):"";let final=text.replace(/<think[\s\S]*?>[\s\S]*?(?:<\/think>)?/gi,"");final=final.replace(/<final>|<\/final>/gi,"").trim();return{think,final}}catch(e){return{think:"",final:text}}}
function buildContextualPrompt(q){const useCtx=$('#use_ctx')?$('#use_ctx').checked:false;const deep=$('#deep_think')?$('#deep_think').checked:false;let head=lang==='zh'?"你是一个具备强上下文理解能力的助手。请在保持连贯性的前提下回答用户问题。":"You are a context-aware assistant. Answer coherently.";if(deep){head+=(lang==='zh'?" 请先在<think>标签中进行完整推理，再在<final>中给出答案。":" First reason in <think>, then output in <final>.")}if(!useCtx){return head+"\n"+(lang==='zh'?"用户：":"User: ")+q}
const lines=[head];const start=Math.max(0,chat.length-10);for(let i=start;i<chat.length;i++){const x=chat[i];const role=x.role==='assistant'?(lang==='zh'?"助手":"Assistant"):(lang==='zh'?"用户":"User");lines.push(`${role}: ${x.text||""}`)}lines.push((lang==='zh'?"用户：":"User: ")+q);return lines.join("\n")}
function _esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;")}
function _inlineFmt(s){let x=s
 x=x.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")
 x=x.replace(/(^|[^*])\*([^*]+)\*(?!\*)/g,"$1<em>$2</em>")
 x=x.replace(/`([^`]+)`/g,"<code>$1</code>")
 x=x.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,"<a href='$2' target='_blank' rel='noopener'>$1</a>")
 x=x.replace(/(https?:\/\/[^\s]+)/g,"<a href='$1' target='_blank' rel='noopener'>$1</a>")
 return x}
function renderRichMarkdown(text){let s=String(text||"")
 const blocks=[]
 s=s.replace(/```(\w+)?[\r\n]*([\s\S]*?)```/g,(m,lang,code)=>{const i=blocks.length;blocks.push({lang:lang||"",code:code});return "\u0000CB"+i+"\u0000"})
 s=_esc(s)
 const lines=s.split(/\r?\n/)
 let html=""
 let ul=false,ol=false
 function close(){if(ul){html+="</ul>";ul=false}if(ol){html+="</ol>";ol=false}}
 for(let i=0;i<lines.length;i++){let ln=lines[i]
 if(/^\s*$/.test(ln)){close();continue}
 let h=ln.match(/^#{1,3}\s+(.*)$/)
 if(h){close();const t=h[1];const lvl=(ln.match(/^#+/)[0].length)||1;const tag=lvl===1?"h3":(lvl===2?"h4":"h5");html+=`<${tag}>${_inlineFmt(t)}</${tag}>`;continue}
 if(/^[-*]\s+/.test(ln)){if(!ul){close();ul=true;html+="<ul>"}const t=ln.replace(/^[-*]\s+/,'');html+=`<li>${_inlineFmt(t)}</li>`;continue}
 if(/^\d+\.\s+/.test(ln)){if(!ol){close();ol=true;html+="<ol>"}const t=ln.replace(/^\d+\.\s+/,'');html+=`<li>${_inlineFmt(t)}</li>`;continue}
 close();html+=`<p>${_inlineFmt(ln)}</p>`}
 close()
 html=html.replace(/\u0000CB(\d+)\u0000/g,(m,idx)=>{const b=blocks[parseInt(idx,10)];const lang=b.lang?` data-lang='${_esc(b.lang)}'`:"";return `<pre><code${lang}>${_esc(b.code)}</code></pre>`})
 return html}
function buildPromptFromChat(){const lines=[];for(let i=Math.max(0,chat.length-6);i<chat.length;i++){const x=chat[i];lines.push(`${x.role}: ${x.text||""}`)}lines.push(lang==="zh"?"请继续完整回答：":"Please continue the answer:");return lines.join("\n")}
function renderChat(filter){const wrap=$("#chat_msgs");if(!wrap)return;wrap.innerHTML="";const items=filter?chat.filter(x=>x.text.toLowerCase().includes(filter.toLowerCase())):chat;items.forEach(x=>{const b=document.createElement("div");b.className=`bubble ${x.role}${x.thinking?" thinking":""}`;if(x.thinking){const tdiv=document.createElement("div");tdiv.className="typing";for(let i=0;i<3;i++){const d=document.createElement("span");d.className="d";tdiv.appendChild(d)}b.appendChild(tdiv)}else{let text=x.text;try{if(x.role==="assistant"){const p=parseThink(text);if(p&&p.final!==undefined){text=p.final;updateThinking(p.think||"")};b.innerHTML=renderRichMarkdown(text)}else{b.textContent=text}}catch(e){b.textContent=text}}wrap.appendChild(b)});wrap.scrollTop=wrap.scrollHeight}
async function generate(){hideAlert();const id=$("#model_select").value;if(!id)return;const device=$("#accelerator").value||"CPU";const base=$("#prompt").value;if(!base)return;const prompt=buildContextualPrompt(base);chat.push({role:"user",text:base});renderChat($("#chat_search").value||"");const thinking={role:"assistant",text:t[lang].thinking,thinking:true};chat.push(thinking);renderChat($("#chat_search").value||"");const maxNewEl=$("#max_new");const tempEl=$("#temperature");const topkEl=$("#top_k");const toppEl=$("#top_p");const repEl=$("#rep_penalty");const autoPerf=$("#auto_perf")?$("#auto_perf").checked:false;const autoMulti=$("#auto_multi")?$("#auto_multi").checked:false;const hetero=$("#hetero_enable")?$("#hetero_enable").checked:false;const config={max_new_tokens:maxNewEl?parseInt(maxNewEl.value,10):2048,temperature:tempEl?parseFloat(tempEl.value):0.7,top_k:topkEl?parseInt(topkEl.value,10):50,top_p:toppEl?parseFloat(toppEl.value):0.9,repetition_penalty:repEl?parseFloat(repEl.value):1.1,perf_mode:autoPerf?"AUTO":($("#perf_mode")?$("#perf_mode").value:undefined),npu_streams:getAdvancedSettings().streams||undefined,npu_tiles:getAdvancedSettings().tiles||undefined,num_requests:getAdvancedSettings().num_requests||undefined,auto_multi:autoMulti,hetero_enable:hetero};const key=`${device}:${id}`;let needOverlay=!_firstLoadShown[key];try{const r0=await fetch(`/api/models/is_loaded?model_id=${encodeURIComponent(id)}&device=${encodeURIComponent(device)}`);if(r0.status===200){const j0=await r0.json();if(j0.loaded===true)needOverlay=false}}catch(_){}let overlayShown=false;if(needOverlay){showOverlay();overlayShown=true}let j;try{const r=await fetch("/api/infer/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,device,prompt,config})});j=await r.json();}catch(e){j={error:String(e)}}if(overlayShown)hideOverlay();if(j.friendly){showAlert(j.message,j.docs_link,j.recommended);const idx=chat.indexOf(thinking);if(idx>-1){chat.splice(idx,1)}renderChat($("#chat_search").value||"");return}const reply=j.output||j.error||"";thinking.thinking=false;thinking.text=reply;renderChat($("#chat_search").value||"");if(j.output){_firstLoadShown[key]=true}}
async function continueGenerate(){hideAlert();const id=$("#model_select").value;if(!id)return;const device=$("#accelerator").value||"CPU";const prompt=buildPromptFromChat();const thinking={role:"assistant",text:t[lang].thinking,thinking:true};chat.push(thinking);renderChat($("#chat_search").value||"");const maxNewEl=$("#max_new");const tempEl=$("#temperature");const topkEl=$("#top_k");const toppEl=$("#top_p");const repEl=$("#rep_penalty");const autoPerf=$("#auto_perf")?$("#auto_perf").checked:false;const autoMulti=$("#auto_multi")?$("#auto_multi").checked:false;const hetero=$("#hetero_enable")?$("#hetero_enable").checked:false;const config={max_new_tokens:maxNewEl?parseInt(maxNewEl.value,10):2048,temperature:tempEl?parseFloat(tempEl.value):0.7,top_k:topkEl?parseInt(topkEl.value,10):50,top_p:toppEl?parseFloat(toppEl.value):0.9,repetition_penalty:repEl?parseFloat(repEl.value):1.1,perf_mode:autoPerf?"AUTO":($("#perf_mode")?$("#perf_mode").value:undefined),npu_streams:getAdvancedSettings().streams||undefined,npu_tiles:getAdvancedSettings().tiles||undefined,num_requests:getAdvancedSettings().num_requests||undefined,auto_multi:autoMulti,hetero_enable:hetero};let j;try{const r=await fetch("/api/infer/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,device,prompt,config})});j=await r.json();}catch(e){j={error:String(e)}}if(j.friendly){showAlert(j.message,j.docs_link,j.recommended);thinking.thinking=false;thinking.text="";renderChat($("#chat_search").value||"");return}const reply=j.output||j.error||"";thinking.thinking=false;thinking.text=reply;renderChat($("#chat_search").value||"")}
async function pollPerf(){try{const r=await fetch("/api/perf");if(r.status!==200)return;const j=await r.json();const el=$("#perf");const a=j.avg||{};const d=j.avg_details||{};const last=j.last||{};let warn="";if(j.warn==="npu_slower_than_cpu")warn="⚠️ NPU性能低于CPU，建议切换加速模式";const ttft=d.ttft||{};const tpot=d.tpot||{};const thr=d.throughput||{};const gen=d.generate||{};if(el)el.textContent=`Latency avg(ms): CPU=${a.CPU||"-"} GPU=${a.GPU||"-"} NPU=${a.NPU||"-"} NVIDIA=${a.NVIDIA||"-"} · TTFT(ms): CPU=${fmt(ttft.CPU)} GPU=${fmt(ttft.GPU)} NPU=${fmt(ttft.NPU)} · TPOT(ms/token): CPU=${fmt(tpot.CPU)} GPU=${fmt(tpot.GPU)} NPU=${fmt(tpot.NPU)} · Thru(tokens/s): CPU=${fmt(thr.CPU)} GPU=${fmt(thr.GPU)} NPU=${fmt(thr.NPU)} · Gen(ms): CPU=${fmt(gen.CPU)} GPU=${fmt(gen.GPU)} NPU=${fmt(gen.NPU)} · last ${last.device||""}=${last.latency_ms||"-"} · 设备(实际): ${last.real_device||"-"} · 回退: ${last.fallback?"是":"否"} ${warn}`;const load=$("#sys_load");if(load){const m=last.metrics||{};const u=j.usage||{};const hp=j.hetero_participation||{};const ft=typeof window.__last_ttft_front!=="undefined"?window.__last_ttft_front:null;const parts=[`当前设备: ${last.device||"-"}`,`设备(实际): ${last.real_device||"-"}`,`回退: ${last.fallback?"是":"否"}`,`延迟: ${fmt(last.latency_ms)}ms`,`TTFT: ${fmt(m.ttft_ms)}`,`TTFT(front): ${ft===null?"-":ft}`,`TPOT: ${fmt(m.tpot_ms)}`,`吞吐: ${fmt(m.throughput_tps)}`];if(typeof u.cpu_percent!=="undefined"&&u.cpu_percent!==null)parts.push(`CPU: ${u.cpu_percent}%`);if(u.npu_mem_total&&u.npu_mem_used){const npup=(u.npu_mem_total?Math.round(u.npu_mem_used/u.npu_mem_total*100):null);parts.push(`NPU内存: ${(u.npu_mem_used/1024/1024).toFixed(0)}/${(u.npu_mem_total/1024/1024).toFixed(0)} MB${npup!==null?` (${npup}%)`:""}`)}if(u.gpu_mem_total&&u.gpu_mem_used){const gpup=(u.gpu_mem_total?Math.round(u.gpu_mem_used/u.gpu_mem_total*100):null);parts.push(`GPU内存: ${(u.gpu_mem_used/1024/1024).toFixed(0)}/${(u.gpu_mem_total/1024/1024).toFixed(0)} MB${gpup!==null?` (${gpup}%)`:""}`)}{const gpup2=(typeof hp.GPU!=="undefined"?Math.round(hp.GPU):null);const npup2=(typeof hp.NPU!=="undefined"?Math.round(hp.NPU):null);if(gpup2!==null||npup2!==null)parts.push(`HETERO参与占比: GPU ${gpup2!==null?gpup2+"%":"-"} · NPU ${npup2!==null?npup2+"%":"-"}`)}if(Array.isArray(u.nvidia)&&u.nvidia.length>0){const nv=u.nvidia[0];parts.push(`NVIDIA: ${nv.util} · ${nv.mem_used}/${nv.mem_total}`)}load.textContent=parts.join(" · ")}}catch(e){}}
function fmt(v){if(v===undefined||v===null)return "-";const n=Number(v);if(!isFinite(n))return "-";return Math.round(n*100)/100}
function init(){setLang(lang);$("#lang").onchange=e=>setLang(e.target.value);$("#btn_download").onclick=startDownload;$("#btn_dl_quant_int8").onclick=downloadAndQuantizeInt8;$("#btn_quant_int8").onclick=()=>quantize("int8");const br=$("#btn_release");if(br)br.onclick=async()=>{const id=$("#model_select").value;if(!id)return;await fetch("/api/models/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id})});showAlert(lang==="zh"?"已释放模型，现在可以删除或切换设备":"Model released. You can delete or switch device.","#",[])};const brg=$("#btn_release_global");if(brg)brg.onclick=async()=>{const id=$("#model_select").value;if(!id)return;await fetch("/api/models/release",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id})});showAlert(lang==="zh"?"已释放模型，现在可以删除或切换设备":"Model released. You can delete or switch device.","#",[])};$("#btn_generate").onclick=generate;const bc=$("#btn_continue");if(bc)bc.onclick=continueGenerate;const cs=$("#chat_search");if(cs)cs.oninput=e=>renderChat(e.target.value||"");const wiz=$("#btn_wizard");if(wiz)wiz.onclick=async()=>{const mod=await import('/static/ui.js');mod.openWizard({acc:$("#accelerator").value,perf:$("#perf_mode").value,streams:getAdvancedSettings().streams||1},(res)=>{if(res){$("#perf_mode").value=res.perf;saveAdvancedSetting('streams',res.streams);updateStreamsUI(res.streams)}})};const advt=$("#adv_toggle");if(advt)advt.onclick=()=>{const card=$("#advanced_card");if(card)card.classList.toggle('collapsed')};const tht=$("#think_toggle");if(tht)tht.onclick=()=>{const card=$("#thinking_card");if(card){card.classList.toggle('collapsed');updateThinking(getThinkingCurrent())}};const thc=$("#think_copy");if(thc)thc.onclick=copyThinking;setupAdvancedSettings();initSplit();applyMaterialTheme();showStartup();setInterval(ping,2000);sys().then(async()=>{const acc=$("#accelerator");if(acc.options.length){const opts=Array.from(acc.options).map(o=>o.value);let saved=null;try{saved=localStorage.getItem('hetero_balance')}catch(e){}const map={igpu_first:'HETERO:GPU,NPU,CPU',balanced:'HETERO:NPU,GPU,CPU',npu_first:'HETERO:NPU,GPU,CPU'};const target=saved?map[saved]:undefined;acc.value=(target&&opts.includes(target))?target:(opts.find(v=>v==="HETERO:NPU,GPU,CPU")||opts.find(v=>v==="MULTI:NPU,GPU")||opts.find(v=>v==="NPU")||opts.find(v=>v==="MULTI:NPU,CPU")||opts.find(v=>v==="MULTI:NPU,GPU,CPU")||opts.find(v=>v==="GPU")||opts.find(v=>v==="CPU")||Array.from(acc.options)[0].value)}updateAccelInfo();acc.onchange=updateAccelInfo;await listModels();const sel=$("#model_select");if(sel.value){const adv=getAdvancedSettings();await fetch("/api/infer/preload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:sel.value,device:acc.value,config:{perf_mode:$("#perf_mode")?$("#perf_mode").value:undefined,npu_streams:adv.streams||undefined,npu_tiles:adv.tiles||undefined,num_requests:adv.num_requests||undefined}})})}});setInterval(pollPerf,3000)}
document.addEventListener("DOMContentLoaded",init)
document.addEventListener("DOMContentLoaded",async()=>{try{const mod=await import('/static/ui.js');mod.attachTooltips()}catch(e){}})
document.addEventListener("DOMContentLoaded",()=>{const h=(location.hash||'#chat').replace('#','');showPage(h)})
window.addEventListener("hashchange",()=>{const h=(location.hash||'#chat').replace('#','');showPage(h)})
document.addEventListener("DOMContentLoaded",()=>{const ta=document.querySelector('#prompt');if(ta){ta.addEventListener('keydown',e=>{if(e.key==='Enter'&&(e.ctrlKey||e.metaKey)){e.preventDefault();generate()}})}})
function showStartup(){const b=$("#startup_banner");if(b)b.classList.remove("hidden")}function hideStartup(){const b=$("#startup_banner");if(b)b.classList.add("hidden")}async function ping(){try{const p=Promise.race([fetch("/api/system/info"),new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),1500))]);const r=await p;if(r&&r.status===200){hideStartup();return true}else{showStartup();return false}}catch(e){showStartup();return false}}
function getAdvancedSettings(){try{const j=JSON.parse(localStorage.getItem('adv_settings')||'{}');return{streams:parseInt(j.streams,10)||2,tiles:parseInt(j.tiles,10)||4,num_requests:parseInt(j.num_requests,10)||6}}catch(e){return{streams:2,tiles:4,num_requests:6}}}
function saveAdvancedSetting(k,v){const j=getAdvancedSettings();j[k]=v;localStorage.setItem('adv_settings',JSON.stringify(j))}
function updateStreamsUI(val){const seg=$("#streams_control");if(!seg)return;Array.from(seg.querySelectorAll('button')).forEach(b=>{b.classList.toggle('active',String(b.getAttribute('data-value'))===String(val))})}
function setupAdvancedSettings(){const adv=getAdvancedSettings();const seg=$("#streams_control");if(seg){Array.from(seg.querySelectorAll('button')).forEach(b=>{b.onclick=()=>{const v=parseInt(b.getAttribute('data-value'),10);saveAdvancedSetting('streams',v);updateStreamsUI(v)}});updateStreamsUI(adv.streams)}const ts=$("#tiles_slider");const tv=$("#tiles_value");if(ts&&tv){ts.value=String(adv.tiles);tv.value=String(adv.tiles);ts.oninput=e=>{tv.value=e.target.value;saveAdvancedSetting('tiles',parseInt(e.target.value,10))};tv.oninput=e=>{let v=parseInt(e.target.value,10)||1;if(v<1)v=1;if(v>4)v=4;tv.value=String(v);ts.value=String(v);saveAdvancedSetting('tiles',v)}}const nr=$("#num_requests");if(nr){nr.value=String(adv.num_requests);nr.oninput=e=>{let v=parseInt(e.target.value,10)||1;if(v<1)v=1;saveAdvancedSetting('num_requests',v)}}const rst=$("#adv_reset");if(rst){rst.onclick=()=>{saveAdvancedSetting('streams',2);saveAdvancedSetting('tiles',4);saveAdvancedSetting('num_requests',6);setupAdvancedSettings()}}}
let _thinking_text="";
function updateThinking(text){_thinking_text=text||"";const card=$("#thinking_card");const full=$("#thinking_content");const sum=$("#thinking_summary");if(!card||!full||!sum)return;const collapsed=card.classList.contains('collapsed');if(collapsed){const s=_thinking_text.replace(/\s+/g,' ').trim();sum.textContent=s.length>160?s.slice(0,160)+"…":s;sum.style.display='block';full.style.display='none'}else{full.textContent=_thinking_text;full.style.display='block';sum.style.display='none'}}
function getThinkingCurrent(){return _thinking_text}
async function copyThinking(){try{const card=$("#thinking_card");const collapsed=card&&card.classList.contains('collapsed');const txt=collapsed?$("#thinking_summary").textContent:$("#thinking_content").textContent;await navigator.clipboard.writeText(txt)}catch(e){}}
function initSplit(){const cont=$("#chat_split");const handle=$("#split_handle");if(!cont||!handle)return;let p=localStorage.getItem('chat_split_pct');let topPct=p?parseFloat(p):40;let bottomPct=100-topPct;function apply(){cont.style.gridTemplateRows=`${topPct}% 8px ${bottomPct}%`}apply();let dragging=false;handle.addEventListener('mousedown',e=>{dragging=true;document.body.style.cursor='row-resize'});window.addEventListener('mouseup',e=>{if(dragging){dragging=false;document.body.style.cursor=''}});window.addEventListener('mousemove',e=>{if(!dragging)return;const r=cont.getBoundingClientRect();const y=e.clientY-r.top;let tp=y/r.height*100;if(tp<20)tp=20;if(tp>80)tp=80;topPct=tp;bottomPct=100-topPct;apply();localStorage.setItem('chat_split_pct',String(Math.round(topPct)))})}
function applyMaterialTheme(){const s=getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()||'#6200ee';function hexToHsl(h){let r=parseInt(h.slice(1,3),16)/255;let g=parseInt(h.slice(3,5),16)/255;let b=parseInt(h.slice(5,7),16)/255;let max=Math.max(r,g,b),min=Math.min(r,g,b);let h_,s_,l=(max+min)/2;if(max===min){h_=0;s_=0}else{let d=max-min;s_=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h_=(g-b)/d+(g<b?6:0);break;case g:h_=(b-r)/d+2;break;case b:h_=(r-g)/d+4;break}h_/=6}return{h:h_*360,s:s_*100,l:l*100}}function hslToHex(h,s,l){s/=100;l/=100;const c=(1-Math.abs(2*l-1))*s;const x=c*(1-Math.abs((h/60)%2-1));const m=l-c/2;let r,g,b;if(h<60){r=c;g=x;b=0}else if(h<120){r=x;g=c;b=0}else if(h<180){r=0;g=c;b=x}else if(h<240){r=0;g=x;b=c}else if(h<300){r=x;g=0;b=c}else{r=c;g=0;b=x}r=Math.round((r+m)*255);g=Math.round((g+m)*255);b=Math.round((b+m)*255);return"#"+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0')}const hsl=hexToHsl(s);const p=hslToHex(hsl.h,Math.min(100,hsl.s),Math.min(70,hsl.l));const sec=hslToHex((hsl.h+200)%360,50,60);const surf=hslToHex(hsl.h,20,98);document.documentElement.style.setProperty('--primary',p);document.documentElement.style.setProperty('--secondary',sec);document.documentElement.style.setProperty('--surface',surf)}
async function streamGenerate(){hideAlert();const id=$("#model_select").value;if(!id)return;const device=$("#accelerator").value||"CPU";const promptEl=$("#prompt");const base=promptEl.value;if(!base)return;chat.push({role:"user",text:base});renderChat($("#chat_search").value||"");promptEl.value="";promptEl.focus();const thinking={role:"assistant",text:t[lang].thinking,thinking:true};chat.push(thinking);renderChat($("#chat_search").value||"");const maxNewEl=$("#max_new");const tempEl=$("#temperature");const topkEl=$("#top_k");const toppEl=$("#top_p");const repEl=$("#rep_penalty");const autoPerf=$("#auto_perf")?$("#auto_perf").checked:false;const autoMulti=$("#auto_multi")?$("#auto_multi").checked:false;const webSearch=$("#web_search")?$("#web_search").checked:false;const hetero=$("#hetero_enable")?$("#hetero_enable").checked:false;const prompt=buildContextualPrompt(base);const config={max_new_tokens:maxNewEl?parseInt(maxNewEl.value,10):2048,temperature:tempEl?parseFloat(tempEl.value):0.7,top_k:topkEl?parseInt(topkEl.value,10):50,top_p:toppEl?parseFloat(toppEl.value):0.9,repetition_penalty:repEl?parseFloat(repEl.value):1.1,perf_mode:autoPerf?"AUTO":($("#perf_mode")?$("#perf_mode").value:undefined),npu_streams:getAdvancedSettings().streams||undefined,npu_tiles:getAdvancedSettings().tiles||undefined,num_requests:getAdvancedSettings().num_requests||undefined,auto_multi:autoMulti,hetero_enable:hetero,web_search:webSearch,search_query:base};const dev2=(hetero&&(device.startsWith("AUTO")||device.startsWith("MULTI")))?("HETERO:"+(device.includes(":")?device.split(":",2)[1]:"")):device;const key=`${dev2}:${id}`;let needOverlay=!_firstLoadShown[key];try{const r0=await fetch(`/api/models/is_loaded?model_id=${encodeURIComponent(id)}&device=${encodeURIComponent(dev2)}`);if(r0.status===200){const j0=await r0.json();if(j0.loaded===true)needOverlay=false}}catch(_){ }let overlayShown=false;if(needOverlay){showOverlay();overlayShown=true}const qs=`model_id=${encodeURIComponent(id)}&device=${encodeURIComponent(dev2)}&prompt=${encodeURIComponent(prompt)}&config=${encodeURIComponent(JSON.stringify(config))}`;let es;let done=false;function close(){if(es)es.close()}async function fallback(){if(done)return;close();let j;try{const r=await fetch("/api/infer/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,device:dev2,prompt,config})});j=await r.json()}catch(e){j={error:String(e)}}if(overlayShown)hideOverlay();if(j.friendly){showAlert(j.message,j.docs_link,j.recommended);const idx=chat.indexOf(thinking);if(idx>-1){chat.splice(idx,1)}renderChat($("#chat_search").value||"");return}const reply=j.output||j.error||"";thinking.thinking=false;thinking.text=reply;renderChat($("#chat_search").value||"")}try{let ts0=Date.now();let ft=null;let inThink=false;let thinkBuf="";es=new EventSource(`/api/infer/stream?${qs}`);es.addEventListener('sources',e=>{try{const d=JSON.parse(e.data);const arr=Array.isArray(d.sources)?d.sources:[];const lines=arr.map((s,i)=>`[${i+1}] ${(s.title||'')} \n ${(s.url||'')} \n ${(s.snippet||'')}`);if(lines.length){updateThinking(lines.join("\n\n"))}}catch(_){}});es.addEventListener('token',e=>{try{const d=JSON.parse(e.data);let seg=d.text||"";if(ft===null)ft=Date.now();if(overlayShown){hideOverlay();overlayShown=false}if(thinking.thinking)thinking.thinking=false;const oopen=/<think[\s\S]*?>/i.test(seg);const oclose=/<\/think>/i.test(seg);if(oopen||inThink){thinkBuf+=seg;inThink=true;if(oclose){inThink=false;try{const cleaned=thinkBuf.replace(/<think[\s\S]*?>|<\/think>/gi,"").trim();if(cleaned)updateThinking(cleaned)}catch(_){ }thinkBuf=""}return}seg=seg.replace(/<final>|<\/final>/gi,"");const cur=thinking.text===t[lang].thinking?"":(thinking.text||"");thinking.text=cur+seg;renderChat($("#chat_search").value||"")}catch(_){}});es.addEventListener('chunk',e=>{try{const d=JSON.parse(e.data);let seg=d.text||"";if(ft===null)ft=Date.now();if(overlayShown){hideOverlay();overlayShown=false}if(thinking.thinking)thinking.thinking=false;const oopen=/<think[\s\S]*?>/i.test(seg);const oclose=/<\/think>/i.test(seg);if(oopen||inThink){thinkBuf+=seg;inThink=true;if(oclose){inThink=false;try{const cleaned=thinkBuf.replace(/<think[\s\S]*?>|<\/think>/gi,"").trim();if(cleaned)updateThinking(cleaned)}catch(_){ }thinkBuf=""}return}seg=seg.replace(/<final>|<\/final>/gi,"");const cur=thinking.text===t[lang].thinking?"":(thinking.text||"");thinking.text=cur+seg;renderChat($("#chat_search").value||"")}catch(_){}});es.addEventListener('final',e=>{try{const d=JSON.parse(e.data);thinking.thinking=false;thinking.text=d.text||"";renderChat($("#chat_search").value||"");done=true;if(overlayShown)hideOverlay();_firstLoadShown[key]=true;window.__last_ttft_front=ft?(ft-ts0):null;close()}catch(_){close();fallback()}});es.addEventListener('error',()=>{close();fallback()})}catch(_){fallback()}}
async function streamContinueGenerate(){hideAlert();const id=$("#model_select").value;if(!id)return;const device=$("#accelerator").value||"CPU";const base=buildPromptFromChat();const prompt=buildContextualPrompt(base);const thinking={role:"assistant",text:t[lang].thinking,thinking:true};chat.push(thinking);renderChat($("#chat_search").value||"");const maxNewEl=$("#max_new");const tempEl=$("#temperature");const topkEl=$("#top_k");const toppEl=$("#top_p");const repEl=$("#rep_penalty");const autoPerf=$("#auto_perf")?$("#auto_perf").checked:false;const autoMulti=$("#auto_multi")?$("#auto_multi").checked:false;const webSearch=$("#web_search")?$("#web_search").checked:false;const hetero=$("#hetero_enable")?$("#hetero_enable").checked:false;const config={max_new_tokens:maxNewEl?parseInt(maxNewEl.value,10):2048,temperature:tempEl?parseFloat(tempEl.value):0.7,top_k:topkEl?parseInt(topkEl.value,10):50,top_p:toppEl?parseFloat(toppEl.value):0.9,repetition_penalty:repEl?parseFloat(repEl.value):1.1,perf_mode:autoPerf?"AUTO":($("#perf_mode")?$("#perf_mode").value:undefined),npu_streams:getAdvancedSettings().streams||undefined,npu_tiles:getAdvancedSettings().tiles||undefined,num_requests:getAdvancedSettings().num_requests||undefined,auto_multi:autoMulti,hetero_enable:hetero,web_search:webSearch,search_query:base};const dev2=(hetero&&(device.startsWith("AUTO")||device.startsWith("MULTI")))?("HETERO:"+(device.includes(":")?device.split(":",2)[1]:"")):device;const qs=`model_id=${encodeURIComponent(id)}&device=${encodeURIComponent(dev2)}&prompt=${encodeURIComponent(prompt)}&config=${encodeURIComponent(JSON.stringify(config))}`;let es;let done=false;function close(){if(es)es.close()}async function fallback(){if(done)return;close();let j;try{const r=await fetch("/api/infer/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:id,device:dev2,prompt,config})});j=await r.json()}catch(e){j={error:String(e)}}const reply=j.output||j.error||"";thinking.thinking=false;thinking.text=reply;renderChat($("#chat_search").value||"")}try{let ts1=Date.now();let ft1=null;let inThink=false;let thinkBuf="";es=new EventSource(`/api/infer/stream?${qs}`);es.addEventListener('sources',e=>{try{const d=JSON.parse(e.data);const arr=Array.isArray(d.sources)?d.sources:[];const lines=arr.map((s,i)=>`[${i+1}] ${(s.title||'')} \n ${(s.url||'')} \n ${(s.snippet||'')}`);if(lines.length){updateThinking(lines.join("\n\n"))}}catch(_){}});es.addEventListener('token',e=>{try{const d=JSON.parse(e.data);let seg=d.text||"";if(ft1===null)ft1=Date.now();if(thinking.thinking)thinking.thinking=false;const oopen=/<think[\s\S]*?>/i.test(seg);const oclose=/<\/think>/i.test(seg);if(oopen||inThink){thinkBuf+=seg;inThink=true;if(oclose){inThink=false;try{const cleaned=thinkBuf.replace(/<think[\s\S]*?>|<\/think>/gi,"").trim();if(cleaned)updateThinking(cleaned)}catch(_){ }thinkBuf=""}return}seg=seg.replace(/<final>|<\/final>/gi,"");const cur=thinking.text===t[lang].thinking?"":(thinking.text||"");thinking.text=cur+seg;renderChat($("#chat_search").value||"")}catch(_){}});es.addEventListener('chunk',e=>{try{const d=JSON.parse(e.data);let seg=d.text||"";if(ft1===null)ft1=Date.now();const oopen=/<think[\s\S]*?>/i.test(seg);const oclose=/<\/think>/i.test(seg);if(oopen||inThink){thinkBuf+=seg;inThink=true;if(oclose){inThink=false;try{const cleaned=thinkBuf.replace(/<think[\s\S]*?>|<\/think>/gi,"").trim();if(cleaned)updateThinking(cleaned)}catch(_){ }thinkBuf=""}return}seg=seg.replace(/<final>|<\/final>/gi,"");if(thinking.thinking)thinking.thinking=false;const cur=thinking.text===t[lang].thinking?"":(thinking.text||"");thinking.text=cur+seg;renderChat($("#chat_search").value||"")}catch(_){}});es.addEventListener('final',e=>{try{const d=JSON.parse(e.data);thinking.thinking=false;thinking.text=d.text||"";renderChat($("#chat_search").value||"");done=true;window.__last_ttft_front=ft1?(ft1-ts1):null;close()}catch(_){close();fallback()}});es.addEventListener('error',()=>{close();fallback()})}catch(_){fallback()}}
generate=streamGenerate
continueGenerate=streamContinueGenerate